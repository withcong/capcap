# CapCap 调试功能说明

## 概览

在本地开发模式（`pnpm dev`）下，CapCap 扩展现在提供了丰富的调试信息，帮助理解和优化智能元素选择算法。

## 新增功能

### 1. 调试面板（右上角）

位于页面右上角的固定面板，显示实时的元素选择信息：

#### 当前元素信息
- **CSS 选择器**: 显示当前悬停元素的选择器（ID 或类名）
- **总得分**: 元素的综合评分，带颜色编码
  - 🟢 绿色 (≥1.0): 高分元素
  - 🟡 黄色 (0-1.0): 中等分数
  - 🔴 红色 (<0): 低分元素

#### 得分详细构成
展示影响最终得分的所有因素：

**正向因素（加分）:**
- **Base**: 基础分 (+1.2)
- **Semantic**: 语义化标签加成 (+0.25)
  - 适用于: `<article>`, `<main>`, `<section>`, `<aside>`, `<nav>`, `<header>`, `<footer>`
- **Media**: 媒体标签加成 (+0.7)
  - 适用于: `<img>`, `<picture>`, `<video>`, `<canvas>`, `<svg>`
- **Role**: ARIA 角色加成 (+0.2)
  - 适用于: `role="main"`, `role="article"`, `role="region"`, `role="dialog"`
- **Background**: 有背景色 (+0.15)
- **Border**: 有边框 (+0.1)

**负向因素（减分）:**
- **Ratio Penalty**: 与目标尺寸比例的偏离程度
  - 目标比例: 25% 视口面积
  - 使用对数惩罚，偏离越多扣分越多
- **Body**: body 或 documentElement 元素 (-2.0)
- **Too Large**: 占据超过 90% 视口 (-1.0)
- **Depth**: 深度惩罚，每层 -0.25

#### 所有候选元素列表
显示当前评估的所有候选元素（最多 5 层祖先）:
- 按得分从高到低排序
- 当前选中的元素会高亮显示
- 每个候选元素显示:
  - CSS 选择器
  - DOM 层级深度
  - 最终得分（颜色编码）

### 2. 浮动工具提示

在当前悬停元素上方显示的简洁提示：
- **元素标签名**: 大写显示（如 DIV, ARTICLE）
- **得分**: 带颜色编码的数值

### 3. 面板操作

- **折叠/展开**: 点击面板标题右侧的 ▲/▼ 按钮
- **可拖动滚动**: 候选元素列表超过一定高度时可以滚动
- **可选择文本**: 可以复制选择器和得分数值用于分析

## 使用场景

### 场景 1: 理解选择逻辑
悬停在页面不同区域，观察：
- 为什么某个元素被选中而不是其祖先/子元素？
- 哪些因素对得分影响最大？
- 语义化标签是否得到了正确的加成？

### 场景 2: 优化算法参数
通过观察不同类型页面的得分分布：
- 调整各项加成/惩罚的权重
- 修改目标尺寸比例（当前 25%）
- 优化深度惩罚系数（当前 0.25/层）

### 场景 3: 调试问题
当用户报告"选错元素"时：
1. 在问题页面启用调试模式
2. 查看所有候选元素及其得分
3. 分析为什么错误元素得分更高
4. 针对性调整评分算法

## 技术实现

### 开发模式检测
```typescript
if (import.meta.env.DEV) {
  // 调试功能代码
}
```

使用 WXT 提供的环境变量，确保调试代码只在开发时执行，生产环境完全不包含。

### 得分详情类型
```typescript
type ScoreDetails = {
  element: Element;
  depth: number;
  score: number;
  breakdown: {
    base: number;
    ratioPenalty: number;
    semanticBonus: number;
    mediaBonus: number;
    roleBonus: number;
    bgBonus: number;
    borderBonus: number;
    bodyPenalty: number;
    largePenalty: number;
    depthPenalty: number;
  };
  rect: DOMRect;
  tagName: string;
  selector: string;
};
```

### 性能影响
- 调试功能仅在开发模式启用
- 使用 Svelte 的响应式系统高效更新 UI
- 候选元素收集仅在 hover 时进行，不影响其他操作

## 注意事项

1. **仅开发模式**: 这些功能只在运行 `pnpm dev` 时可用，生产构建不包含任何调试代码
2. **不影响功能**: 调试 UI 不会干扰正常的截图操作
3. **UI 层级**: 调试面板在 CapCap overlay 下方，不会被截图捕获

## 示例截图流程

1. 启动开发服务器: `pnpm dev`
2. 在浏览器中加载扩展
3. 按 `Cmd+Shift+X` (Mac) 或 `Ctrl+Shift+X` (Windows/Linux) 激活 CapCap
4. 移动鼠标悬停在不同元素上
5. 观察右上角调试面板的实时更新
6. 查看元素上方的得分提示
7. 分析候选元素列表，理解选择逻辑

## 未来改进

可能的增强功能：
- [ ] 导出调试数据为 JSON
- [ ] 录制和回放 hover 会话
- [ ] 可视化显示所有候选元素的边界框
- [ ] 热力图显示页面不同区域的得分分布
- [ ] 性能统计（评分耗时、候选元素数量等）
